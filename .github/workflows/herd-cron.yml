name: HERD Scheduled Jobs

on:
  schedule:
    # Every minute (GitHub Actions minimum granularity)
    - cron: "* * * * *"
    # Every 10 minutes
    - cron: "*/10 * * * *"
    # Every hour at minute 5
    - cron: "5 * * * *"
    # Every day at 02:15 UTC
    - cron: "15 2 * * *"
  workflow_dispatch: {}

jobs:
  run-jobs:
    runs-on: ubuntu-latest
    steps:
      - name: Call scheduled Edge Functions
        env:
          BASE_URL: https://ndxoyswdvtvcftcmiwit.supabase.co/functions/v1
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          set -euo pipefail

          BASE_URL_CLEAN="$(printf %s "$BASE_URL" | tr -d '\r\n')"
          EVENT="${{ github.event_name }}"
          CRON="${{ github.event.schedule || '' }}"
          AUTH_KEY="${SUPABASE_SERVICE_ROLE_KEY:-}"
          if [ -z "$AUTH_KEY" ]; then
            AUTH_KEY="${SUPABASE_ANON_KEY:-}"
          fi
          AUTH_HEADERS=()
          if [ -n "$AUTH_KEY" ]; then
            AUTH_HEADERS=(-H "Authorization: Bearer $AUTH_KEY" -H "apikey: $AUTH_KEY")
          fi

          echo "Event: $EVENT"
          echo "Schedule: $CRON"
          echo "Base URL: $BASE_URL_CLEAN"

          call_fn () {
            FN_NAME="$1"
            echo ""
            echo "Calling $FN_NAME..."
            RESP=$(curl -sS -X POST "$BASE_URL_CLEAN/$FN_NAME" \
              -H "Content-Type: application/json" \
              -H "x-cron-secret: $CRON_SECRET" \
              "${AUTH_HEADERS[@]}" \
              --data '{}' \
              -w "\nHTTP_STATUS:%{http_code}\n")

            echo "$RESP"

            STATUS=$(echo "$RESP" | sed -n 's/^HTTP_STATUS://p')
            if [ -z "$STATUS" ] || [ "$STATUS" -lt 200 ] || [ "$STATUS" -ge 300 ]; then
              echo "❌ $FN_NAME failed with status $STATUS"
              exit 1
            fi

            echo "✅ $FN_NAME OK"
          }

          # If run manually, run everything
          if [ "$EVENT" = "workflow_dispatch" ]; then
            call_fn "expire-pending-bookings"
            call_fn "send-unread-message-alerts"
            call_fn "release-held-payments"
            call_fn "send-review-invites"
            exit 0
          fi

          # Scheduled runs: execute only what matches the triggering cron string
          case "$CRON" in
            "*/10 * * * *")
              call_fn "expire-pending-bookings"
              call_fn "send-unread-message-alerts"
              ;;
            "* * * * *")
              call_fn "emails"
              ;;
            "5 * * * *")
              call_fn "release-held-payments"
              ;;
            "15 2 * * *")
              call_fn "send-review-invites"
              ;;
            *)
              echo "Unknown schedule trigger: '$CRON' — doing nothing."
              ;;
          esac
